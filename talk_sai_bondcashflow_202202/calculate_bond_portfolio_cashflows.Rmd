---
title: "Calculate Bond Portfolio Cashflows"
author: "Mick Cooney"
date: "Last updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  rmdformats::readthedown:
    toc_depth: 3
    use_bookdown: TRUE
    code_folding: hide
    fig_caption: TRUE

  html_document:
    fig_caption: yes
    theme: spacelab #sandstone #spacelab #flatly
    highlight: pygments
    number_sections: TRUE
    toc: TRUE
    toc_depth: 3
    toc_float:
      smooth_scroll: FALSE

  pdf_document: default
---


```{r import_libraries, echo=FALSE, message=FALSE}
library(conflicted)
library(tidyverse)
library(scales)
library(cowplot)
library(magrittr)
library(rlang)
library(fs)
library(stringr)
library(glue)
library(purrr)
library(furrr)
library(DT)
library(lubridate)
library(curl)


source("lib_utils.R")

conflict_lst <- resolve_conflicts(
  c("magrittr", "rlang", "dplyr", "readr", "purrr", "ggplot2", "DT")
  )


knitr::opts_chunk$set(
  tidy       = FALSE,
  cache      = FALSE,
  warning    = FALSE,
  message    = FALSE,
  fig.height =     8,
  fig.width  =    11
  )

options(
  width = 80L,
  warn  = 1,
  mc.cores = parallel::detectCores()
  )

theme_set(theme_cowplot())

set.seed(42)

plan(multisession)
```


# Load Data

We first want to load our datasets and prepare them for some simple association
rules mining.

## Load Portfolio Data

We load a first example of our portfolio, containing the basic information we
need to properly account for cashflows.

```{r load_input_data, echo=TRUE}
portfolio_cols <- cols(
  issuer        = col_character(),
  currency      = col_character(),
  coupon        = col_number(),
  issued_date   = col_date(format = "%Y-%m-%d"),
  maturity_date = col_date(format = "%Y-%m-%d"),
  price         = col_number(),
  position      = col_integer()
  )

first_portfolio_tbl <- read_csv(
  file      = "data/sample_bond_portfolio.csv",
  col_types = portfolio_cols
  )

first_portfolio_tbl %>% glimpse()
```


## Retrieve Frech-Fama Breakpoints

```{r download_ff_me_breakpoints, echo=TRUE}
if(file_exists("data/ME_Breakpoints_CSV.zip")) {
  me_breakpoint_url <- "http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/ME_Breakpoints_CSV.zip"
  
  curl_download(me_breakpoint_url, destfile = "data/ME_Breakpoints_CSV.zip")
}
```

We now need to process this breakpoint data.

```{r }


read_lines("data/ME_Breakpoints_CSV.zip") %>%
  enframe(name = "id", value = "line_str") %>%
  mutate(char_count = map_int(line_str, nchar), .after = id) %>%
  filter(char_count == 232) %>%
  pull(line_str) %>%
  write_lines("data/breakpoints_parsed.csv")

csv_colnames <- c(
    "datestr", "data_count",
    "ME00", "ME05", "ME10", "ME15", "ME20",
    "ME25", "ME30", "ME35", "ME40", "ME45",
    "ME50", "ME55", "ME60", "ME65", "ME70",
    "ME75", "ME80", "ME85", "ME90", "ME95"
    )

csv_cols <- cols(
  datestr    = col_character(),
  data_count = col_integer()
  )


me_breakpoint_tbl <- read_csv(
  "data/breakpoints_parsed.csv",
  col_names = csv_colnames,
  col_types = csv_cols
  )


```


## Futures Expiration Dates

We also want to load the expiration dates for futures to assist the hedging of
currency risks.

```{r load_futures_expiration_date, echo=TRUE}
expiration_date_tbl <- read_csv(
  "data/expiration_date.csv",
  col_type = cols(expiration_date = col_date())
  )

expiration_date_tbl %>% glimpse()
```



# Construct Cashflow Data

```{r create_coupon_payment_dates, echo=TRUE}
create_coupon_payment_dates <- function(init_date, final_date) {
  max_year <- difftime(final_date, init_date, units = "days") %>%
    as.numeric() %>%
    divide_by(183) %>%
    ceiling()

  coupon_date_tbl <- (init_date %m+% months(6 * 1:max_year)) %>%
    enframe(name = NULL, value = "cashflow_date") %>%
    filter(cashflow_date <= final_date)
  
  return(coupon_date_tbl)
}
```


```{r calculate_cashflow_data, echo=TRUE}
calculate_cashflow_data <- function(init_date, final_date, position, coupon,
                                    contract_size = 1000) {
  
  par_value      <- position  * contract_size
  coupon_payment <- par_value * coupon * 0.01
  
  coupon_data_tbl <- create_coupon_payment_dates(init_date, final_date) %>%
    mutate(
      cashflow_amt = coupon_payment
      )
  
  final_tbl <- tibble(
    cashflow_date = final_date,
    cashflow_amt  = par_value
    )
  
  cashflow_tbl <- list(coupon_data_tbl, final_tbl) %>%
    bind_rows()
  
  return(cashflow_tbl)
}
```


```{r calculate_portfolio_cashflow_data, echo=TRUE}
calculate_portfolio_cashflow_data <- function(portfolio_tbl, current_date,
                                              id_cols = c("issuer", "currency")) {
  cashflow_tbl <- first_portfolio_tbl %>%
    mutate(
      cash_data = pmap(
        list(
          init_date  = issued_date,
          final_date = maturity_date,
          position   = position,
          coupon     = coupon
          ),
        calculate_cashflow_data,
        contract_size = 1000
        )
      ) %>%
    select(any_of(id_cols), cash_data) %>%
    unnest(cash_data) %>%
    filter(cashflow_date >= current_date) %>%
    arrange(cashflow_date)
  
  return(cashflow_tbl)
}
```


```{r calculate_portfolio_cashflows, echo=TRUE}
bond_cashflow_tbl <- bond_portfolio_tbl %>%
  calculate_portfolio_cashflow_data(
    current_date = as.Date("2019-01-01")
    )

bond_cashflow_tbl %>% glimpse()
```


## Aggregate Weekly Cashflows

We now want to aggregate all these cashflows on a weekly basis to help assess
the FX risk due to holding bonds in both currencies.

```{r calculate_weekly_aggregated_cashflows, echo=TRUE}
aggregate_cashflows_tbl <- bond_cashflow_tbl %>%
  mutate(
    agg_date = map(cashflow_date, ~ friday_dates[friday_dates >= .x][1]) %>% reduce(c)) %>%
  group_by(currency, agg_date) %>%
  summarise(
    .groups = "drop",
    
    agg_cashflow = sum(cashflow_amt)
    ) %>%
  arrange(agg_date, currency)

aggregate_cashflows_tbl %>% glimpse()
```


## Calculate Futures Delivery Expirations

```{r calculate_futures_expiration_cashflows, echo=TRUE}
expry_dates <- expiration_date_tbl %>% pull(expiration_date)

futures_exposures_tbl <- bond_cashflow_tbl %>%
  mutate(
    exposure_date = map(cashflow_date, ~ expry_dates[expry_dates >= .x][1]) %>% reduce(c)
    ) %>%
  group_by(exposure_date, currency) %>%
  mutate(
    total_exposure = cumsum(cashflow_amt) %>% round(2)
    ) %>%
  ungroup()


aggregate_cashflows_tbl %>% glimpse()
```

We now show this table using the `DT` package

```{r display_aggregate_cashflow, echo=TRUE}
aggregate_cashflows_tbl %>% datatable()
```


# R Environment
 
```{r show_session_info, echo=TRUE, message=TRUE}
sessioninfo::session_info()
```
