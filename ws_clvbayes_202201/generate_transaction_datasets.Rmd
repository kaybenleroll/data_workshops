---
title: "Generate Synthetic Customer Transaction Datasets"
author: "Mick Cooney <mickcooney@gmail.com>"
date: "Last updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  rmdformats::readthedown:
    toc_depth: 3
    use_bookdown: TRUE
    code_folding: hide
    fig_caption: TRUE

  html_document:
    fig_caption: yes
    theme: spacelab #sandstone #spacelab #flatly
    highlight: pygments
    number_sections: TRUE
    toc: TRUE
    toc_depth: 2
    toc_float:
      smooth_scroll: FALSE

  pdf_document: default
---


```{r import_libraries, echo=FALSE, message=FALSE}
library(conflicted)
library(tidyverse)
library(scales)
library(cowplot)
library(directlabels)
library(magrittr)
library(rlang)
library(fs)
library(purrr)
library(furrr)
library(glue)
library(tidyquant)


source("lib_utils.R")
source("lib_data_generation.R")

conflict_lst <- resolve_conflicts(
  c("magrittr", "rlang", "dplyr", "readr", "purrr", "ggplot2", "tidyquant")
  )


knitr::opts_chunk$set(
  tidy       = FALSE,
  cache      = FALSE,
  warning    = FALSE,
  message    = FALSE,
  fig.height =     8,
  fig.width  =    11
  )

options(
  width = 80L,
  warn  = 1,
  mc.cores = parallel::detectCores()
  )

theme_set(theme_cowplot())

set.seed(42)

plan(multisession)
```


In this workbook we use some initial inputs to generate synthetic data to help
us explore various customer CLV  models.


# Load Input Data

As a means of simplifying the process of generating synthetic data, and 
because we are not attempting to model the arrival of new customers, we will
use some summary data on the first transaction data of each customer as an
input to this process.

```{r load_customer_input_data, echo=TRUE}
customer_cohort_data_tbl <- read_rds("data/customer_cohort_tbl.rds")

customer_cohort_data_tbl %>% glimpse()
```

For the purposes of this work, we can treat the quarterly times as categorical
and so we convert these values to character strings.

```{r convert_cohort_qtr_values, echo=TRUE}
customer_cohort_data_tbl <- customer_cohort_data_tbl %>%
  transmute(
    customer_id,
    cohort_qtr = cohort_qtr %>% as.character(),
    cohort_ym,
    first_tnx_date
    )

customer_cohort_data_tbl %>% glimpse()
```


# Run Data Generation for Basic Model

We now want to set up the various parameters required for the data generation.

```{r setup_synthesis_parameters, echo=TRUE}
pnbd_params_lst <- list(
  mu_shape     =   1,
  mu_rate      =  10,

  lambda_shape =   1,
  lambda_rate  =   3,

  mx_p         = 100,
  mx_q         =   1,
  mx_g         =   1
  )


final_date_observed <- customer_cohort_data_tbl %>%
  pull(first_tnx_date) %>%
  max()
```


Now that we have set our 'hyper-parameters' set for the data generation we
produce individual parameters for each of the customers.

```{r calculate_basicmodel_customer_sim_params, echo=TRUE}
customer_basic_simparams_tbl <- customer_cohort_data_tbl %>%
  generate_pnbd_customer_simulation_params(
    params_lst     = pnbd_params_lst
    )

customer_basic_simparams_tbl %>% glimpse()

customer_basic_transactions_tbl <- customer_basic_simparams_tbl %>%
  generate_pnbd_customer_transaction_data(
    final_tnx_date = as.Date("2011-12-09")
    ) %>%
  arrange(tnx_timestamp) %>%
  group_by(tnx_date = as.Date(tnx_timestamp)) %>%
  mutate(
    invoice_id = sprintf("%s_%04d", format(tnx_date, "%Y%m%d"), 1:n())
    ) %>%
  ungroup() %>%
  select(customer_id, tnx_timestamp, invoice_id, tnx_amount)

customer_basic_transactions_tbl %>% glimpse()
```


### Write Data to Disk

We now write this data to disk.

```{r write_basic_data_disk, echo=TRUE}
customer_basic_simparams_tbl %>%
  write_rds("data/customer_basic_simparams_tbl.rds")

customer_basic_transactions_tbl %>%
  write_rds("data/customer_basic_transactions_tbl.rds")
```


# Generate Synthetic Cohort Data

We now repeat this exercise, but rather than using the new customer data from
the transaction dataset, we also create a synthetic set of 'new customers' and
generate a transaction dataset based on that.

```{r generate_synthetic_cohort, echo=TRUE}
n_customers = 50000

customer_synth_cohort_tbl <- generate_customer_cohort_data(
    n_customers = n_customers,
    first_date  = as.Date("2011-01-01"),
    last_date   = as.Date("2018-12-31")
    )

customer_synth_cohort_tbl %>% glimpse()
```



```{r calculate_synthmodel_customer_data, echo=TRUE}
pnbd_params_lst <- list(
  mu_shape     =   1,
  mu_rate      =  10,

  lambda_shape =   1,
  lambda_rate  =   3,

  mx_p         = 100,
  mx_q         =   1,
  mx_g         =   1
  )

customer_synth_simparams_tbl <- customer_synth_cohort_tbl %>%
  generate_pnbd_customer_simulation_params(
    params_lst     = pnbd_params_lst
    )

customer_synth_transactions_tbl <- customer_synth_simparams_tbl %>%
  generate_pnbd_customer_transaction_data(
    final_tnx_date = as.Date("2019-01-01")
    ) %>%
  arrange(tnx_timestamp) %>%
  group_by(tnx_date = as.Date(tnx_timestamp)) %>%
  mutate(
    invoice_id = sprintf("%s_%04d", format(tnx_date, "%Y%m%d"), 1:n())
    ) %>%
  ungroup() %>%
  select(customer_id, tnx_timestamp, invoice_id, tnx_amount)

customer_synth_transactions_tbl %>% glimpse()
```


### Write Data to Disk

We now write this data to disk.

```{r write_synth_data_disk, echo=TRUE}
customer_synth_cohort_tbl %>%
  write_rds("data/customer_synth_050000_cohort_tbl.rds")

customer_synth_simparams_tbl %>%
  write_rds("data/customer_synth_050000_simparams_tbl.rds")

customer_synth_transactions_tbl %>%
  write_rds("data/customer_synth_050000_transactions_tbl.rds")
```








# R Environment

```{r show_session_info, echo=TRUE, message=TRUE}
options(width = 120L)
sessioninfo::session_info()
options(width = 80L)
```
