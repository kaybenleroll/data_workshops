---
title: "Building Customer Lifetime Models"
author: "Mick Cooney <mickcooney@gmail.com>"
date: "Last updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  rmdformats::readthedown:
    toc_depth: 3
    use_bookdown: TRUE
    code_folding: hide
    fig_caption: TRUE

  html_document:
    fig_caption: yes
    theme: spacelab #sandstone #spacelab #flatly
    highlight: pygments
    number_sections: TRUE
    toc: TRUE
    toc_depth: 2
    toc_float:
      smooth_scroll: FALSE

  pdf_document: default
---


```{r import_libraries, echo=FALSE, message=FALSE}
library(conflicted)
library(tidyverse)
library(scales)
library(cowplot)
library(directlabels)
library(magrittr)
library(rlang)
library(fs)
library(purrr)
library(furrr)
library(glue)
library(cmdstanr)
library(brms)
library(posterior)
library(bayesplot)
library(tidybayes)


source("lib_utils.R")
source("lib_btyd.R")

conflict_lst <- resolve_conflicts(
  c("magrittr", "rlang", "dplyr", "readr", "purrr", "ggplot2")
  )


knitr::opts_chunk$set(
  tidy       = FALSE,
  cache      = FALSE,
  warning    = FALSE,
  message    = FALSE,
  fig.height =     8,
  fig.width  =    11
  )

options(
  width        = 80L,
  warn         = 1,
  brms.backend = "cmdstanr",
  mc.cores     = parallel::detectCores()
  )

theme_set(theme_cowplot())

set.seed(42)

plan(multisession)
```

In this workbook we investigate different ways to model the lifetime of
individual customers, with a view to expanding this approach with our
frequency into a more traditional P/NBD model.


# Load and Configure Datasets

We first want to load some synthetic transaction data with a fixed transaction
frequency which allowed for a varying lifetime.


```{r load_synth_transaction_data, echo=TRUE}
customer_cohort_tbl <- read_rds("data/synthdata_lifetime_cohort_tbl.rds")
customer_cohort_tbl %>% glimpse()

customer_simparams_tbl <- read_rds("data/synthdata_lifetime_simparams_tbl.rds")
customer_simparams_tbl %>% glimpse()

customer_transactions_tbl <- read_rds("data/synthdata_lifetime_transactions_tbl.rds")
customer_transactions_tbl %>% glimpse()
```

We also want to set up a number of parameters for use in this workbook

```{r setup_workbook_parameters, echo=TRUE}
stan_modeldir <- "stan_models"
stan_codedir  <-   "stan_code"
```


## Calculate Summary Statistics

We also want to calculate the summary statistics for each of these customers
based on an observation date of Jan 1 2020.


```{r construct_frequency_modelling_data, echo=TRUE}
customer_summarystats_tbl <- customer_transactions_tbl %>%
  calculate_transaction_cbs_data(
    last_date = as.Date("2020-01-01")
    )

customer_summarystats_tbl %>% glimpse()
```





## Load Subsets Values

As we did before, we have a subset of customer IDs to be used when taking
subsets of the data.

```{r construct_data_subset_ids, echo=TRUE}
shuffle_tbl <- customer_summarystats_tbl %>%
  slice_sample(n = nrow(.), replace = FALSE)

id_1000  <- shuffle_tbl %>% head(1000)  %>% pull(customer_id) %>% sort()
id_5000  <- shuffle_tbl %>% head(5000)  %>% pull(customer_id) %>% sort()
id_10000 <- shuffle_tbl %>% head(10000) %>% pull(customer_id) %>% sort()
```



## Visualise the Transaction Data

As always, we want to visualise this data as much as we can to get a feel for
it, so we construct a plot of each customer.

```{r construct_sample_transaction_visualisations, echo=TRUE}
tnx_plot_tbl <- customer_transactions_tbl %>%
  group_nest(customer_id, .key = "tnx_data") %>%
  filter(map_int(tnx_data, nrow) > 1) %>%
  slice_sample(n = 50) %>%
  unnest(tnx_data)

ggplot(tnx_plot_tbl, aes(x = tnx_timestamp, y = customer_id)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Date",
    y = "Customer ID",
    title = "Visualisation of Transactions for Sample of Customers"
    ) +
  theme(
    axis.text.y = element_text(size = 8)
    )
```



As part of the lifetime analysis, we need to take a look at times between
transactions and we use this as part of our analysis later.

For the moment, we just want to see how the time differences work.

```{r construct_customer_timediff_data, echo=TRUE}
customer_timediffs_tbl <- customer_transactions_tbl %>%
  group_by(customer_id) %>%
  mutate(
    tnx_timediff = difftime(
        tnx_timestamp, lag(tnx_timestamp),
        units = "weeks") %>%
      as.numeric()
    ) %>%
  ungroup()

ggplot(customer_timediffs_tbl %>% drop_na(tnx_timediff)) +
  geom_histogram(aes(x = tnx_timediff), bins = 50) +
  scale_y_continuous(labels = label_comma()) +
  labs(
    x = "Weeks",
    y = "Count",
    title = "Histogram of Weeks Between Successive Transactions"
    )
```

We can see that almost all time differences are less than 75 weeks, but it is
worth looking at a summary of the raw data.

```{r show_customer_tnx_timediffs_summary, echo=TRUE}
customer_timediffs_tbl %>% pull(tnx_timediff) %>% summary()
```

Considering this data, we can say that a customer has 'died' in our model 100
weeks after the most recent transaction. We can use this information in our
model.


## Construct the Model Data


We first calculate the summary statistics from the data.

```{r calculate_customer_cbs_data, echo=TRUE}
customer_lifetime_stats_tbl <- customer_transactions_tbl %>%
  calculate_transaction_cbs_data(
    last_date = as.Date("2020-01-01")
    ) %>%
  mutate(
    min_lifetime = t_x,
    max_lifetime = pmin(t_x + 100, T_cal)
    )

customer_lifetime_stats_tbl %>% glimpse()
```

For our initial fit, we use only 1,000 eligible customers to reduce computation
time and construct a dataset used to fit these models.

```{r construct_fit_1000_data, echo=TRUE}
fit_1000_data_tbl <- customer_lifetime_stats_tbl %>%
  filter(customer_id %in% id_1000)

fit_1000_data_tbl %>% glimpse()
```

We do the same for the 10k customers.

```{r construct_fit_10000_data, echo=TRUE}
fit_10000_data_tbl <- customer_lifetime_stats_tbl %>%
  filter(customer_id %in% id_10000)

fit_10000_data_tbl %>% glimpse()
```




# Construct Flat Lifetime Model

We now turn our attention to fitting our model to get estimates of the
lifetime of the customer.




```{r compile_lifetimemodel_flat_stanmodel, echo=TRUE}
lifetimemodel_flat_stanmodel <- cmdstan_model(
  "stan_code/lifetimemodel_flat.stan",
  include_paths =   stan_codedir,
  pedantic      =           TRUE,
  dir           =  stan_modeldir
  )
```

We then use this compiled model with our data to produce a fit of the data.

```{r fit_lifetimemodel_flat_stanmodel, echo=TRUE}
stan_modelname <- "lifetimemodel_flat"

stan_data_lst <- fit_1000_data_tbl %>%
  select(customer_id, min_lifetime, max_lifetime) %>%
  compose_data()

lifetimemodel_flat_stanfit <- lifetimemodel_flat_stanmodel$sample(
  data            =        stan_data_lst,
  chains          =                    4,
  iter_warmup     =                  500,
  iter_sampling   =                  500,
  seed            =                 4201,
  output_dir      =        stan_modeldir,
  output_basename =       stan_modelname
  )

lifetimemodel_flat_stanfit$summary()
```



# R Environment

```{r show_session_info, echo=TRUE, message=TRUE}
options(width = 120L)
sessioninfo::session_info()
options(width = 80L)
```
