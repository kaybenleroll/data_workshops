---
title: "Building Hierarchical Transactional Frequency Models"
author: "Mick Cooney <mickcooney@gmail.com>"
date: "Last updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  rmdformats::readthedown:
    toc_depth: 3
    use_bookdown: TRUE
    code_folding: hide
    fig_caption: TRUE

  html_document:
    fig_caption: yes
    theme: spacelab #sandstone #spacelab #flatly
    highlight: pygments
    number_sections: TRUE
    toc: TRUE
    toc_depth: 2
    toc_float:
      smooth_scroll: FALSE

  pdf_document: default
---


```{r import_libraries, echo=FALSE, message=FALSE}
library(conflicted)
library(tidyverse)
library(scales)
library(cowplot)
library(directlabels)
library(magrittr)
library(rlang)
library(fs)
library(purrr)
library(furrr)
library(glue)
library(cmdstanr)
library(brms)
library(posterior)
library(bayesplot)
library(tidybayes)


source("lib_utils.R")

conflict_lst <- resolve_conflicts(
  c("magrittr", "rlang", "dplyr", "readr", "purrr", "ggplot2")
  )


knitr::opts_chunk$set(
  tidy       = FALSE,
  cache      = FALSE,
  warning    = FALSE,
  message    = FALSE,
  fig.height =     8,
  fig.width  =    11
  )

options(
  width        = 80L,
  warn         = 1,
  brms.backend = "cmdstanr",
  mc.cores     = parallel::detectCores()
  )

theme_set(theme_cowplot())

set.seed(42)

plan(multisession)
```

In this workbook we investigate different ways to model the transaction
frequency of individual customers, with a view to expanding this approach into
a more traditional P/NBD model.

# Load and Configure Datasets

We first want to load some synthetic transaction data.

```{r load_synth_transaction_data, echo=TRUE}
customer_cohort_tbl <- read_rds("data/synthdata_singleyear_cohort_tbl.rds")
customer_cohort_tbl %>% glimpse()

customer_simparams_tbl <- read_rds("data/synthdata_singleyear_simparams_tbl.rds")
customer_simparams_tbl %>% glimpse()

customer_transactions_tbl <- read_rds("data/synthdata_singleyear_transactions_tbl.rds")
customer_transactions_tbl %>% glimpse()

customer_summarystats_tbl <- read_rds("data/synthdata_singleyear_summarystats_tbl.rds")
customer_summarystats_tbl %>% glimpse()
```

We also want to set up a number of parameters for use in this workbook

```{r setup_workbook_parameters, echo=TRUE}
stan_modeldir <- "stan_models"
stan_codedir  <-   "stan_code"
```

We also want to load the subset of `customer_id` so it is consistent with the
previous workbooks

```{r load_id_subsets, echo=TRUE}
id_1000  <- read_rds("data/id_1000.rds")
id_5000  <- read_rds("data/id_5000.rds")
id_10000 <- read_rds("data/id_10000.rds")
```

We now want to construct data used to fit the models.

```{r construct_fit_data, echo=TRUE}
fit_1000_data_tbl <- customer_summarystats_tbl %>%
  filter(
    customer_id %in% id_1000
    )

fit_1000_data_tbl %>% glimpse()


fit_10000_data_tbl <- customer_summarystats_tbl %>%
  filter(
    customer_id %in% id_10000
    )

fit_10000_data_tbl %>% glimpse()
```




## Load Frequency Data

We also wish to load the frequency summary data as we use this for a number
of modelling tasks.

```{r load_frequency_modelling_data, echo=TRUE}
customer_summarystats_tbl <- read_rds("data/customer_summarystats_tbl.rds")
customer_summarystats_tbl %>% glimpse()

nonhier_comparison_distrib_tbl <- read_rds("data/customer_comparison_distrib_tbl.rds")
nonhier_comparison_distrib_tbl %>% glimpse()
```


# Construct Hierarchical Frequency Model

In our previous models we fixed the parameters for our Gamma hyper-distribution
and passed those values in as 'data' to the model.

While this worked from a fitting perspective, it has the problem that it
required a strong knowledge of what those parameters should be, whereas a more
Bayesian approach would instead be to capture this uncertainty by putting
distributions around those parameters.

This issue leads to another concern when dealing with fitting probability
distributions: the parameters are often co-dependent. This is because, unlike
some of the more common distributions, many distributions are not naturally
parametrised by location parameters.

Instead, we often try to fit distributions using location and dispersion, and
then convert these back to the standard parametrisation.

For the Gamma distribution, we can fit a location parameter $\mu$ and the
co-efficient of variation $\nu$ (the standard-deviation divided by the mean).
These then convert to the shape parameter $r$ and rate parameter $\alpha$ using
the following relationship:

\begin{eqnarray*}
r      &=& \frac{1}{\nu^2}      \\
\alpha &=& \frac{1}{\mu \nu^2}
\end{eqnarray*}


We do this in Stan by using the `transformed parameters` block to convert
$(\mu, \nu)$ into $(r, \alpha)$, so we can use those fitting the models.


```{r display_freqmodel_hier_stancode, echo=FALSE}
read_lines("stan_code/freqmodel_hier.stan") %>% cat(sep = "\n")
```

We now need to think about the parameters for the hierarchical priors, so once
again we try something like we had before.

```{r investigate_hierarchical_mu_prior, echo=TRUE}
x_vals <- seq(0, 1.5, by = 0.01)
y_vals <- dgamma(x_vals, shape = 1, rate = 3)

ggplot() +
  geom_line(aes(x = x_vals, y = y_vals)) +
  labs(
    x = "mu",
    y = "Density",
    title = "Distribution for Prior on mu"
    )
```

This gives us a good spread of values and so should work fine.

We do a similar task for the spread of values of the co-efficient of variation,
which we will estimate to be around 1.

```{r investigate_hierarchical_nu_prior, echo=TRUE}
x_vals <- seq(0, 3, by = 0.01)
y_vals <- dgamma(x_vals, shape = 2, rate = 2)

ggplot() +
  geom_line(aes(x = x_vals, y = y_vals)) +
  labs(
    x = "mu",
    y = "Density",
    title = "Distribution for Prior on nu"
    )
```



## Compile and Fit First Hierarchical Model

We first need to compile this fitted model.

```{r compile_freqmodel_hier_stanmodel, echo=TRUE}
freqmodel_hier_stanmodel <- cmdstan_model(
  "stan_code/freqmodel_hier.stan",
  include_paths = stan_codedir,
  pedantic      =  TRUE,
  dir           = stan_modeldir
  )
```


We then use this compiled model with our data to produce a fit of the data.

```{r fit_freqmodel_hier_stanmodel, echo=TRUE}
stan_modelname <- "freqmodel_hier"

stan_data_lst <- fit_1000_data_tbl %>%
  select(customer_id, btyd_count, tnx_weeks = all_weeks) %>%
  compose_data(
    mu_p1 = 1,
    mu_p2 = 2,
    
    cov_p1 = 2,
    cov_p2 = 2
    )

freqmodel_hier_stanfit <- freqmodel_hier_stanmodel$sample(
  data            =        stan_data_lst,
  chains          =                    4,
  iter_warmup     =                  500,
  iter_sampling   =                  500,
  seed            =                  421,
  output_dir      =        stan_modeldir,
  output_basename =       stan_modelname
  )

freqmodel_hier_stanfit$summary()
```

We also want to check the various HMC diagnostics.

```{r check_freqmodel_hier_diagnostics, echo=TRUE}
freqmodel_hier_stanfit$cmdstan_diagnose()
```





# R Environment

```{r show_session_info, echo=TRUE, message=TRUE}
options(width = 120L)
sessioninfo::session_info()
options(width = 80L)
```
