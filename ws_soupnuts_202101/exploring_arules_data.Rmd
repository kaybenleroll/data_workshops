---
title: "Using Association Rules of the Online Retail Dataset"
author: "Mick Cooney <mickcooney@gmail.com>"
date: "Last updated: `r format(Sys.time(), '%B %d, %Y')`"
output:
  rmdformats::readthedown:
    toc_depth: 3
    use_bookdown: yes

  html_document:
    fig_caption: yes
    theme: spacelab #sandstone #spacelab #flatly
    highlight: pygments
    number_sections: TRUE
    toc: TRUE
    toc_depth: 2
    toc_float:
      smooth_scroll: FALSE

  pdf_document: default
---


```{r import_libraries, echo=FALSE, message=FALSE}
library(conflicted)
library(tidyverse)
library(scales)
library(cowplot)
library(magrittr)
library(rlang)
library(purrr)
library(vctrs)
library(fs)
library(glue)
library(forcats)
library(arules)
library(arulesViz)
library(DT)


source("custom_functions.R")

resolve_conflicts(c("magrittr", "rlang", "dplyr", "readr", "purrr", "ggplot2"))


knitr::opts_chunk$set(
  tidy       = FALSE,
  cache      = FALSE,
  warning    = FALSE,
  message    = FALSE,
  fig.height =     8,
  fig.width  =    11
  )

options(
  width = 80L,
  warn  = 1,
  mc.cores = parallel::detectCores()
  )

theme_set(theme_cowplot())

set.seed(42)
```

# Load Data

We first want to load our datasets and prepare them for some simple association
rules mining.

```{r load_transaction_data, echo=TRUE}
tnx_data_tbl <- read_rds("data/retail_data_tbl.rds")

tnx_data_tbl %>% glimpse()
```

To use our rules mining we just need the invoice data and the stock code, so
we can ignore the rest. Also, we ignore the issue of returns and just look at
purchases.

```{r prepare_data_arules, echo=TRUE}
tnx_purchase_tbl <- tnx_data_tbl %>%
  filter(quantity > 0) %>%
  select(invoice_id, stock_code, quantity, price, stock_amount, description)

tnx_purchase_tbl %>% glimpse()
```

We now write this data out as a CSV so `arules` can read it in and process it.

```{r read_transactions, echo=TRUE}
tnx_purchase_tbl %>% write_csv("data/tnx_purchase_tbl.csv")
```



# Basket Analysis with Association Rules

We now want to do some basic basket analysis using association rules, which
tries to determine which items get bought together, similar to taking a graph
approachin many ways.

```{r setup_arules_structures, echo=TRUE}
basket_arules <- read.transactions(
    file   = "data/tnx_purchase_tbl.csv",
    format = "single",
    sep    = ",",
    header = TRUE,
    cols   = c("invoice_id", "stock_code")
    )

basket_arules %>% glimpse()
```

Now that we have this data we can look at some basic plots much like we
produced before. For example, we can look at the relative frequency of the
different items.

```{r plot_arules_item_frequency, echo=TRUE}
itemFrequencyPlot(basket_arules, topN = 15)

itemFrequencyPlot(basket_arules, topN = 15, type = "absolute")
```

The stock codes do not mean a huge amount to us, so we also want to look at
the description field for these items.

```{r show_frequency_items, echo=TRUE}
freq_codes <- itemFrequency(basket_arules) %>%
  sort(decreasing = TRUE) %>%
  head(15) %>%
  names()

tnx_purchase_tbl %>%
  select(stock_code, description) %>%
  filter(stock_code %in% freq_codes) %>%
  distinct() %>%
  arrange(stock_code) %>%
  datatable()

```

## Construct apriori Rules

We now want to construct the `apriori` rules for that. We need to set some
parameters such as the minimum support (the proportion of total transactions
in which those items appear), and the confidence level - the proportion of
the transactions containing one item which also contains the others.

```{r construct_apriori_rules, echo=TRUE}
basket_apriori <- apriori(
    basket_arules,
    parameter = list(supp = 0.005, conf = 0.8)
    )

basket_apriori %>% inspectDT()
```









# R Environment

```{r show_session_info, echo=TRUE, message=TRUE}
sessioninfo::session_info()
```
